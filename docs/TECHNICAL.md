# Technical Reference

This document describes the internal implementation and data model for the Budget Forecast Engine (Google Apps Script).

---

## 1) High-level Architecture

The system is split into two layers:

1. **Google Sheets workbook** (state + inputs + outputs)
2. **Apps Script runtime** (forecast engine + writers)

The workbook is the source of truth. Outputs are deterministically regenerated on each run; there is no hidden state in code.

---

## 2) Sheet Model

### Inputs

#### Accounts
- Columns: Account Name, Balance, Type, Include, Sink Fund
- Type: enum { Cash, Credit }
- Include: boolean determines if account participates in forecast outputs
- Sink Fund: boolean used for sink fund rollup

#### Income
- Columns: Include, Name, Amount, Frequency, Start Date, End Date, To Account, Notes
- Include: boolean, if false rule is ignored
- Frequency: enum (Daily, Weekly, Fortnightly, Monthly, Bi-Monthly, Quarterly, SemiAnnually, Annually, One-off)

#### Expense
- Columns: Include, Transaction Type, Category, Name, Amount, Frequency, Start Date, End Date, From Account, To Account, Notes
- Transaction Type: enum { Expense, Repayment, Transfer }
- To Account can be an internal account or “External” (tracked as money leaving the model)

### Outputs

#### Journal
- Each row is a forecasted event, plus running balances for each forecast account.
- Column shape:
  - Date
  - Account
  - Transaction Type
  - Name
  - Amount
  - Alerts
  - One column per forecast account (running balance)

#### Daily
- Snapshot per day across the forecast window.
- Columns: Date, Total Cash, Total Debt, Net Position, then one column per forecast account.

#### Monthly
- Aggregated stats per month.
- For totals (Cash, Debt, Net): Min, Max, Net Change, End.
- For each account: Min, Max, Net Change, End.

#### Logs
- Timestamped engine logs (INFO / WARN / ERROR).

---

## 3) Forecast Pipeline

### a) Read inputs
- `Readers.readAccounts()`
- `Readers.readIncome()`
- `Readers.readExpenses()`

### b) Generate events
- Income rules -> income events
- Expense rules -> expense/transfer events

### c) Build journal
- `buildJournalRows_()` constructs event rows + running balances.
- Each event is applied in chronological order with deterministic recurrence.

### d) Write outputs
- `Writers.writeJournal()` writes the Journal and applies formatting.
- Summaries are built from the Journal:
  - `buildDailySummaryFromJournal_()`
  - `buildMonthlySummary_()`

---

## 4) Recurrence Engine

Recurrence is anchored and deterministic:

- Each rule has a **Frequency** and **Start Date**.
- Future dates are generated by stepping forward from the anchor date.
- Monthly+ steps clamp to end-of-month as needed.

Supported frequencies:
- Daily, Weekly, Fortnightly, Monthly, Bi-Monthly, Quarterly, SemiAnnually, Annually, One-off

---

## 5) Money Flow Rules

### Event types
- **Income**: increases account balance
- **Expense**: reduces account balance
- **Transfer**: moves balance between accounts

### Special behavior
- **Repayment** transfers can auto-cap to the remaining credit balance.
- **CapOnly** expenses do not affect balances.

---

## 6) Formatting + Ordering

### Sheet ordering
All major flows call a single ordering routine to ensure consistent tab order:

Dashboard ? Accounts ? Income ? Expense ? Journal ? Daily ? Monthly ? Export ? Reference ? Logs

### Summary formatting
- Group borders are vertical-only (no horizontal borders)
- Account groups get unique background colors
- Formatting is cleared and reapplied on each run

---

## 7) Export Behavior

- The Export dialog allows selecting which core sheets to export.
- Data is written into the **Export** tab in a compact, tab-separated format.
- Output is chunked if data exceeds per-cell limits.

---

## 8) Source Map

Main modules:
- `00_Config.gs` (constants + names)
- `10_Readers.gs` (input parsing)
- `20_Events.gs` (event generation)
- `30_Recurrence.gs` (date stepping)
- `40_Engine.gs` (forecast pipeline)
- `50_Writers.gs` (output writing)
- `60_Summary.gs` (daily/monthly summaries)
- `07_Export.gs` (export routines)

---

## 9) Determinism + State

- Outputs are fully reproducible.
- Inputs are the only state.
- Rerunning forecast always regenerates Journal and downstream summaries.
