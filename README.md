# Budget Forecast Engine — README

## 1. Purpose and Scope

This application is a **forward-looking budget and cash-flow forecasting engine**.

It is designed to:
- forecast future balances based on known rules
- model cash pressure, debt trajectories, and reserved funds
- be rerun frequently as reality changes

It is **not** designed to:
- track historical transactions
- reconcile planned vs actuals
- serve as an accounting system

If something has already happened in real life, the user updates **starting balances** and reruns the forecast.

---

## 2. High-level Architecture

The system consists of two parts:

1. **Spreadsheet (data + outputs)**
2. **Forecast engine (Apps Script code)**

The spreadsheet defines **state and rules**.  
The code reads those rules, generates events, applies them to balances, and writes outputs.

There is **no hidden state** in the code.

---

## 3. Spreadsheet Structure

This is a **single workbook** with clearly separated concerns.

# Budget sheet

Spreadsheet
├─ Inputs
│ ├─ Accounts
│ ├─ Income
│ ├─ Expense
│
├─ Outputs (generated)
│ ├─ Forecast Journal
│ ├─ Daily Summary
│ ├─ Overview
│ └─ Logs


Users **only edit the Inputs**.  
Outputs are regenerated and overwritten on every run.

---

## 4. Conceptual Model

### Accounts
An **account** is any balance that should be forecasted.

- Cash accounts  
  - Holding  
  - Savings  
  - Bucket accounts (Car Fund, Holiday Fund, etc.)
- Credit accounts  
  - Credit Card  
  - Loans

Balances in `Accounts` represent **“now”**.

---

### External
Anything not modeled as an account:
- merchants
- rent
- utilities
- subscriptions

---

### Money movements
There are only two kinds of movements:

| Movement | Description |
|-------|------------|
| Expense | Money leaves the system (`Paid To = External`) |
| Transfer | Money moves between accounts (`Paid To = Account`) |

This distinction is **implied**, not stored as a separate type.

---

## 5. Expense Behaviors (core abstraction)

Every expense rule has a **Behavior** that determines how the engine treats it.

### Behavior types

| Behavior | Purpose |
|-------|--------|
| Scheduled | Known, expected payments |
| Provision | Regular allocation into a bucket |
| CapOnly | Informational budget caps |
| OneOff | Single known future payment |

This allows routine, non-routine, and discretionary spending to coexist cleanly.

---

## 6. Recurrence Model

The recurrence system is **anchored and deterministic**.

Each recurring rule defines:
- a **Frequency**
- an **Anchor Date**

Future events are generated by stepping forward from the anchor.

### Supported frequencies

| Frequency | Step |
|--------|-----|
| Weekly | +7 days |
| Fortnightly | +14 days |
| Monthly | +1 month |
| Quarterly | +3 months |
| SemiAnnually | +6 months |
| Annually | +12 months |
| Once | no recurrence |

Notes:
- Monthly+ steps clamp to end-of-month if needed
- Fortnightly is intentionally anchored (matches real pay cycles)
- Calendar-aligned quarters are intentionally **not** modeled

---

## 7. Bucket Accounts (Provisioning)

Bucket accounts are **normal Cash accounts** used for planning.

Examples:
- Car Fund
- Holiday Fund
- Emergency Fund

### How they work
- Provision rules transfer money into buckets
- Buckets are never auto-spent by the engine
- When real spending occurs:
  - user updates the bucket balance
  - reruns forecast

This keeps the model forward-only and avoids fake future transactions.

---

## 8. Sheet Schemas (explicit)

### 8.1 `Accounts`

| Column | Type | Required | Description |
|-----|-----|---------|------------|
| Account Name | string | ✅ | Unique identifier |
| Balance | number | ✅ | Starting balance |
| Type | enum | ✅ | Cash / Credit |

---

### 8.2 `Income`

| Column | Type | Required | Description |
|-----|-----|---------|------------|
| Active | boolean | ✅ | Include in forecast |
| Name | string | ✅ | Label |
| Amount | number | ✅ | > 0 |
| Frequency | enum | ✅ | Recurrence |
| Anchor Date | date | ✅ | First occurrence |
| Paid To | ref(Account) | ✅ | Destination account |
| Notes | string | ⛔ | Optional |

---

### 8.3 `Expense`

| Column | Type | Required | Description |
|-----|-----|---------|------------|
| Active | boolean | ✅ | Include in forecast |
| Behavior | enum | ✅ | Scheduled / Provision / CapOnly / OneOff |
| Category | string | ⛔ | Reporting |
| Name | string | ✅ | Label |
| Amount | number | ✅ | ≥ 0 |
| Frequency | enum | ⛔ | Required unless CapOnly / OneOff |
| Anchor Date | date | ⛔ | Required for Scheduled / Provision |
| Once Date | date | ⛔ | Required for OneOff |
| Paid From | ref(Account) | ⛔ | Required unless CapOnly |
| Paid To | ref(Account or External) | ⛔ | Required for Scheduled / Provision |
| Notes | string | ⛔ | Optional |

---

## 9. Output Sheets

### 9.1 Forecast Journal
This is the **authoritative audit trail**.

Each row represents a generated event.

Typical columns:
- Date
- Kind (Income / Expense / Transfer)
- Behavior
- Name
- Category
- From
- To
- Amount
- Balance after event (per account)

Purpose:
- explain *why* balances change
- debug unexpected results

---

### 9.2 Daily Summary
Derived from the journal.

One row per day:
- account balances
- total cash
- total debt
- net position

Used for:
- charts
- overview calculations

---

### 9.3 Overview
A human-readable summary of the forecast.

Typical sections:
- Opening vs ending balances
- Minimum Holding balance and date
- Bucket balances (reserved cash)
- Debt change
- Net position change
- Monthly provisions
- Discretionary caps

---

### 9.4 Logs
Generated warnings and diagnostics:
- invalid references
- skipped rows
- negative cash warnings

---

## 10. Application (Code) Structure

The code is intentionally modular.  
Each file owns a **single responsibility**.

Code
├─ Config
├─ Readers
├─ Event Builders
├─ Engine
├─ Writers
├─ Utils
└─ Logger


---

### 10.1 Config
Defines:
- sheet names
- forecast horizon
- supported frequencies
- enums (Behaviors, Account Types)

Purpose: avoid magic strings and centralize assumptions.

---

### 10.2 Readers
Responsibilities:
- read input sheets
- convert rows into typed objects
- validate references (accounts, required fields)
- ignore inactive rows

No forecasting logic lives here.

---

### 10.3 Event Builders
Responsibilities:
- turn Income rules into income events
- turn Expense rules into expense/transfer events
- apply Behavior semantics
- expand recurrence into dated events

Output: a flat list of **normalized events**.

---

### 10.4 Engine
Responsibilities:
- sort events by date
- apply events to balances
- produce:
  - Forecast Journal rows
  - Daily Summary rows
  - Summary statistics

This is pure business logic.

---

### 10.5 Writers
Responsibilities:
- clear and write output sheets
- format tables
- optionally create charts

No calculations happen here.

---

### 10.6 Utils
Shared helpers:
- date math
- number parsing
- cloning
- formatting

---

### 10.7 Logger
Responsibilities:
- structured logging
- warnings instead of silent failures
- easy debugging

---

## 11. Invariants (guarantees)

- Forecast is always forward-only
- Outputs are fully reproducible
- No hidden state
- Buckets are never auto-spent
- CapOnly rules never affect balances
- Updating balances is the only way to reflect reality

---

## 12. What this system is optimized for

- frequent reruns
- scenario testing
- clarity and explainability
- realistic cash planning
- low maintenance overhead

---

## 13. What this system intentionally avoids

- historical bookkeeping
- transaction import
- reconciliation
- predictive discretionary timing
- accounting-grade precision
