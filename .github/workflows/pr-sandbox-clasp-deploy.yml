name: PR Sandbox Deploy (clasp)

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - 'src/**'
      - 'scripts/**'
      - '.github/workflows/pr-sandbox-clasp-deploy.yml'

permissions:
  contents: read

concurrency:
  group: clasp-sandbox-pr-${{ github.event.pull_request.number || github.ref_name }}
  cancel-in-progress: true

jobs:
  deploy-sandbox:
    # Secrets are not available to forked PRs; skip safely.
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest
    env:
      CLASP_SANDBOX_SCRIPT_ID: ${{ secrets.CLASP_SANDBOX_SCRIPT_ID }}
      CLASP_OAUTH_CREDENTIALS: ${{ secrets.CLASP_OAUTH_CREDENTIALS }}
      CLASP_SCRIPT_ID_TEST: ${{ secrets.CLASP_SCRIPT_ID_TEST }}
      CLASP_CREDENTIALS_JSON: ${{ secrets.CLASP_CREDENTIALS_JSON }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve and validate secrets
        shell: bash
        run: |
          SCRIPT_ID="${CLASP_SANDBOX_SCRIPT_ID:-$CLASP_SCRIPT_ID_TEST}"
          CREDENTIALS="${CLASP_OAUTH_CREDENTIALS:-$CLASP_CREDENTIALS_JSON}"

          if [ -z "$SCRIPT_ID" ]; then
            echo "Missing secret: CLASP_SANDBOX_SCRIPT_ID (or CLASP_SCRIPT_ID_TEST)"
            exit 1
          fi
          if [ -z "$CREDENTIALS" ]; then
            echo "Missing secret: CLASP_OAUTH_CREDENTIALS (or CLASP_CREDENTIALS_JSON)"
            exit 1
          fi

          echo "SCRIPT_ID=$SCRIPT_ID" >> "$GITHUB_ENV"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Configure clasp auth
        shell: bash
        run: |
          CREDENTIALS="${CLASP_OAUTH_CREDENTIALS:-$CLASP_CREDENTIALS_JSON}"
          printf '%s' "$CREDENTIALS" > "$HOME/.clasprc.json"

      - name: Configure sandbox script target
        shell: bash
        run: |
          cat > .clasp.json <<EOF
          {
            "scriptId": "${SCRIPT_ID}",
            "rootDir": "src",
            "scriptExtensions": [".js", ".gs"],
            "htmlExtensions": [".html"],
            "jsonExtensions": [".json"],
            "filePushOrder": [],
            "skipSubdirectories": false
          }
          EOF

      - name: Push source to sandbox
        shell: bash
        run: |
          npx --yes @google/clasp@latest push --force
